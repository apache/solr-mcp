# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

services:
  solr:
    image: solr:9-slim
    ports:
      - "8983:8983"
    networks: [ search ]
    environment:
      ZK_HOST: "zoo:2181"
      SOLR_HEAP: "1g"
    depends_on: [ zoo ]
    volumes:
      - data:/var/solr
      - ./mydata:/mydata
      - ./init-solr.sh:/init-solr.sh
    command: [ "bash", "/init-solr.sh" ]

  zoo:
    image: zookeeper:3.9
    networks: [ search ]
    environment:
      ZOO_4LW_COMMANDS_WHITELIST: "mntr,conf,ruok"

  # =============================================================================
  # OpenTelemetry LGTM Stack (HTTP mode only)
  # =============================================================================
  # Provides a complete observability stack for local development:
  # - Grafana: Visualization dashboards (http://localhost:3000)
  # - Loki: Log aggregation
  # - Tempo: Distributed tracing
  # - Mimir: Metrics storage (Prometheus-compatible)
  # - OpenTelemetry Collector: Receives OTLP data on ports 4317 (gRPC) and 4318 (HTTP)
  #
  # Usage:
  #   docker compose up -d lgtm   # Start only the observability stack
  #   docker compose up -d        # Start everything including Solr
  #
  # Access Grafana at http://localhost:3000 (no authentication required)
  # Pre-configured datasources for Loki, Tempo, and Mimir are available.
  lgtm:
    image: grafana/otel-lgtm:latest
    ports:
      - "3000:3000"   # Grafana UI
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
    networks: [ search ]
    labels:
      # Disable Spring Boot Docker Compose auto-configuration for this service
      # We configure OTLP endpoints manually in application-http.properties
      org.springframework.boot.ignore: "true"
    environment:
      # Disable authentication for local development
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: "Admin"

volumes:
  data:

networks:
  search:
    driver: bridge
